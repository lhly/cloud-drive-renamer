# ==========================================
# GitHub Actions Workflow: Release Automation
# ==========================================
#
# åŠŸèƒ½ï¼šè‡ªåŠ¨åŒ– Chrome æ‰©å±•å‘å¸ƒæµç¨‹
#
# è§¦å‘æ¡ä»¶ï¼š
#   - æ¨é€æ ¼å¼ä¸º v*.*.* çš„ Git æ ‡ç­¾ï¼ˆå¦‚ v0.1.0, v1.2.3ï¼‰
#
# å·¥ä½œæµç¨‹ï¼š
#   1. ç¯å¢ƒå‡†å¤‡ï¼šæ£€å‡ºä»£ç ï¼Œè®¾ç½® Node.js ç¯å¢ƒ
#   2. ä¾èµ–å®‰è£…ï¼šä½¿ç”¨ npm ci å®‰è£…é”å®šç‰ˆæœ¬çš„ä¾èµ–
#   3. è´¨é‡æ£€æŸ¥ï¼šè¿è¡Œæµ‹è¯•ã€ç±»å‹æ£€æŸ¥ã€ä»£ç æ£€æŸ¥
#   4. æ„å»ºæ‰“åŒ…ï¼šç¼–è¯‘æ‰©å±•å¹¶åˆ›å»º ZIP å‘å¸ƒåŒ…
#   5. å‘å¸ƒåˆ†å‘ï¼šåˆ›å»º GitHub Release å¹¶é™„åŠ å‘å¸ƒæ–‡ä»¶
#
# è¾“å‡ºäº§ç‰©ï¼š
#   - dist/ ç›®å½•ï¼šå®Œæ•´çš„æ‰©å±•æ„å»ºäº§ç‰©
#   - cloud-drive-renamer-{version}.zipï¼šå¯ç›´æ¥å®‰è£…çš„æ‰©å±•åŒ…
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   git tag v0.1.0
#   git push origin v0.1.0
#
# ==========================================

name: Release

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾
on:
  push:
    tags:
      - 'v*.*.*'

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„äº§

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'  # Node.js LTS ç‰ˆæœ¬
  ARTIFACT_NAME: 'chrome-extension-dist'  # æ„å»ºäº§ç‰©åç§°

jobs:
  # ==========================================
  # Job 1: æ„å»ºå’Œæµ‹è¯•
  # ==========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------
      # æ­¥éª¤ 1: ç¯å¢ƒå‡†å¤‡
      # ------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´ Git å†å²ï¼ˆç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—ï¼‰

      # ------------------------------------------
      # æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ
      # ------------------------------------------
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  # å¯ç”¨ npm ç¼“å­˜åŠ é€Ÿ

      # ------------------------------------------
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      # ------------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: npm ci  # ä½¿ç”¨ ci è€Œé install ç¡®ä¿å¯é‡ç°æ€§

      # ------------------------------------------
      # æ­¥éª¤ 4: è¿è¡Œå®Œæ•´ CI æµç¨‹ï¼ˆè´¨é‡æ£€æŸ¥ + æ„å»ºï¼‰
      # ------------------------------------------
      - name: ğŸš€ Run complete CI pipeline
        run: npm run ci
        continue-on-error: false  # è´¨é‡æ£€æŸ¥å¤±è´¥åˆ™ä¸­æ­¢å‘å¸ƒ

      # ------------------------------------------
      # æ­¥éª¤ 5: éªŒè¯æ„å»ºäº§ç‰©
      # ------------------------------------------
      - name: âœ… Verify build artifacts
        run: |
          echo "ğŸ“‹ Checking required files..."

          # å¿…éœ€æ–‡ä»¶æ¸…å•
          required_files=(
            "dist/manifest.json"
            "dist/icons/icon16.png"
            "dist/icons/icon48.png"
            "dist/icons/icon128.png"
          )

          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Error: Missing required file: $file"
              exit 1
            fi
            echo "âœ“ $file"
          done

          echo ""
          echo "ğŸ“Š Build statistics:"
          echo "Total files: $(find dist -type f | wc -l)"
          echo "Total size: $(du -sh dist | cut -f1)"
          echo ""
          echo "âœ… All required files present"

      # ------------------------------------------
      # æ­¥éª¤ 6: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¾›åç»­ Job ä½¿ç”¨ï¼‰
      # ------------------------------------------
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: dist/
          retention-days: 7  # ä¿ç•™ 7 å¤©

  # ==========================================
  # Job 2: åˆ›å»º Release
  # ==========================================
  create-release:
    name: Create GitHub Release
    needs: build-and-test  # ä¾èµ– build-and-test æˆåŠŸå®Œæˆ
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------
      # æ­¥éª¤ 2: ä¸‹è½½æ„å»ºäº§ç‰©
      # ------------------------------------------
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: dist/

      # ------------------------------------------
      # æ­¥éª¤ 3: æå–ç‰ˆæœ¬å·
      # ------------------------------------------
      - name: ğŸ·ï¸ Extract version from tag
        id: version
        run: |
          # ä» Git æ ‡ç­¾æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤ v å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}"

      # ------------------------------------------
      # æ­¥éª¤ 4: åˆ›å»º ZIP å‘å¸ƒåŒ…
      # ------------------------------------------
      - name: ğŸ“¦ Create release ZIP
        run: |
          cd dist
          zip -r ../cloud-drive-renamer-${{ steps.version.outputs.version }}.zip .
          cd ..

          echo "ğŸ“Š ZIP file details:"
          ls -lh cloud-drive-renamer-${{ steps.version.outputs.version }}.zip

      # ------------------------------------------
      # æ­¥éª¤ 5: ç”Ÿæˆå˜æ›´æ—¥å¿—
      # ------------------------------------------
      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          echo "## ğŸ‰ What's Changed" > CHANGELOG.txt
          echo "" >> CHANGELOG.txt

          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "ğŸ†• Initial release" >> CHANGELOG.txt
          else
            echo "ğŸ“‹ Changes since ${PREV_TAG}:" >> CHANGELOG.txt
            echo "" >> CHANGELOG.txt
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.txt
          fi

          echo "" >> CHANGELOG.txt
          echo "" >> CHANGELOG.txt
          echo "## ğŸ“¥ Installation" >> CHANGELOG.txt
          echo "" >> CHANGELOG.txt
          echo "1. Download \`cloud-drive-renamer-${{ steps.version.outputs.version }}.zip\`" >> CHANGELOG.txt
          echo "2. Extract the ZIP file" >> CHANGELOG.txt
          echo "3. Open Chrome and navigate to \`chrome://extensions/\`" >> CHANGELOG.txt
          echo "4. Enable \"Developer mode\"" >> CHANGELOG.txt
          echo "5. Click \"Load unpacked\" and select the extracted folder" >> CHANGELOG.txt
          echo "" >> CHANGELOG.txt
          echo "## ğŸ”— Supported Cloud Drives" >> CHANGELOG.txt
          echo "" >> CHANGELOG.txt
          echo "- ğŸŒ Quark (å¤¸å…‹ç½‘ç›˜)" >> CHANGELOG.txt
          echo "- â˜ï¸ Aliyun Drive (é˜¿é‡Œäº‘ç›˜)" >> CHANGELOG.txt
          echo "- ğŸ¯ Baidu Pan (ç™¾åº¦ç½‘ç›˜)" >> CHANGELOG.txt

          cat CHANGELOG.txt

      # ------------------------------------------
      # æ­¥éª¤ 6: åˆ›å»º GitHub Release
      # ------------------------------------------
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.version }}
          body_path: CHANGELOG.txt
          draft: false  # è®¾ä¸º true åˆ™åˆ›å»ºè‰ç¨¿ï¼ˆéœ€è¦æ‰‹åŠ¨å‘å¸ƒï¼‰
          prerelease: false  # è®¾ä¸º true åˆ™æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            cloud-drive-renamer-${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------
      # æ­¥éª¤ 7: è¾“å‡ºå‘å¸ƒä¿¡æ¯
      # ------------------------------------------
      - name: ğŸ“£ Release summary
        run: |
          echo "âœ… Release created successfully!"
          echo ""
          echo "ğŸ“¦ Version: v${{ steps.version.outputs.version }}"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          echo "ğŸ“¥ Download: cloud-drive-renamer-${{ steps.version.outputs.version }}.zip"
          echo ""
          echo "ğŸ‰ Next steps:"
          echo "1. Verify the release on GitHub"
          echo "2. Download and test the extension locally"
          echo "3. (Optional) Upload to Chrome Web Store manually"
