# ==========================================
# GitHub Actions Workflow: Continuous Integration
# ==========================================
#
# åŠŸèƒ½ï¼šæŒç»­é›†æˆæµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥
#
# è§¦å‘æ¡ä»¶ï¼š
#   - Pull Request åˆ›å»ºæˆ–æ›´æ–°
#   - æŽ¨é€åˆ° main åˆ†æ”¯
#
# å·¥ä½œæµç¨‹ï¼š
#   1. ä¾èµ–å®‰è£…å’Œç¼“å­˜
#   2. è¿è¡Œæµ‹è¯•å¥—ä»¶
#   3. TypeScript ç±»åž‹æ£€æŸ¥
#   4. ESLint ä»£ç æ£€æŸ¥
#   5. éªŒè¯æž„å»ºæˆåŠŸ
#
# ç›®çš„ï¼š
#   - ç¡®ä¿æ‰€æœ‰ä»£ç å˜æ›´é€šè¿‡è´¨é‡æ£€æŸ¥
#   - åœ¨åˆå¹¶å‰å‘çŽ°æ½œåœ¨é—®é¢˜
#   - ä¿æŒä»£ç åº“å¥åº·
#
# ==========================================

name: CI

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ç›¸åŒå·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # Job: è´¨é‡æ£€æŸ¥
  # ==========================================
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------
      # æ­¥éª¤ 2: è®¾ç½® Node.js
      # ------------------------------------------
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ------------------------------------------
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      # ------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: npm ci

      # ------------------------------------------
      # æ­¥éª¤ 4: è¿è¡Œæµ‹è¯•ï¼ˆå¸¦è¦†ç›–çŽ‡ï¼‰
      # ------------------------------------------
      - name: ðŸ§ª Run tests with coverage
        run: npm run test:coverage
        continue-on-error: false

      # ------------------------------------------
      # æ­¥éª¤ 5: ä¸Šä¼ æµ‹è¯•è¦†ç›–çŽ‡
      # ------------------------------------------
      - name: ðŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      # ------------------------------------------
      # æ­¥éª¤ 6: TypeScript ç±»åž‹æ£€æŸ¥
      # ------------------------------------------
      - name: ðŸ” Run type checking
        run: npm run typecheck

      # ------------------------------------------
      # æ­¥éª¤ 7: ESLint ä»£ç æ£€æŸ¥
      # ------------------------------------------
      - name: ðŸŽ¨ Run linting
        run: npm run lint

      # ------------------------------------------
      # æ­¥éª¤ 8: æž„å»ºéªŒè¯
      # ------------------------------------------
      - name: ðŸ—ï¸ Build extension
        run: npm run build

      # ------------------------------------------
      # æ­¥éª¤ 9: éªŒè¯æž„å»ºäº§ç‰©
      # ------------------------------------------
      - name: âœ… Verify build
        run: |
          echo "ðŸ“‹ Verifying build artifacts..."

          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          test -f dist/manifest.json || exit 1
          test -f dist/icons/icon16.png || exit 1
          test -f dist/icons/icon48.png || exit 1
          test -f dist/icons/icon128.png || exit 1

          echo "âœ… Build verification passed"

      # ------------------------------------------
      # æ­¥éª¤ 10: æ€»ç»“
      # ------------------------------------------
      - name: ðŸ“£ CI Summary
        if: always()
        run: |
          echo "## âœ… CI Checks Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Type checking passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build succeeded" >> $GITHUB_STEP_SUMMARY
