# ==========================================
# GitHub Actions Workflow: Continuous Integration
# ==========================================
#
# åŠŸèƒ½ï¼šæŒç»­é›†æˆæµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥
#
# è§¦å‘æ¡ä»¶ï¼š
#   - Pull Request åˆ›å»ºæˆ–æ›´æ–°
#   - æŽ¨é€åˆ° main åˆ†æ”¯
#
# å·¥ä½œæµç¨‹ï¼š
#   1. ä¾èµ–å®‰è£…å’Œç¼“å­˜
#   2. è¿è¡Œæµ‹è¯•å¥—ä»¶
#   3. TypeScript ç±»åž‹æ£€æŸ¥
#   4. ESLint ä»£ç æ£€æŸ¥
#   5. éªŒè¯æž„å»ºæˆåŠŸ
#
# ç›®çš„ï¼š
#   - ç¡®ä¿æ‰€æœ‰ä»£ç å˜æ›´é€šè¿‡è´¨é‡æ£€æŸ¥
#   - åœ¨åˆå¹¶å‰å‘çŽ°æ½œåœ¨é—®é¢˜
#   - ä¿æŒä»£ç åº“å¥åº·
#
# ==========================================

name: CI

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ç›¸åŒå·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # Job: è´¨é‡æ£€æŸ¥
  # ==========================================
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------
      # æ­¥éª¤ 2: è®¾ç½® Node.js
      # ------------------------------------------
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ------------------------------------------
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      # ------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: npm ci

      # ------------------------------------------
      # æ­¥éª¤ 4: è¿è¡Œå®Œæ•´ CI æµç¨‹ï¼ˆè´¨é‡æ£€æŸ¥ + æž„å»ºï¼‰
      # ------------------------------------------
      - name: ðŸš€ Run CI pipeline
        run: npm run ci
        continue-on-error: false
        timeout-minutes: 5

      # ------------------------------------------
      # æ­¥éª¤ 5: ä¸Šä¼ æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š
      # ------------------------------------------
      - name: ðŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      # ------------------------------------------
      # æ­¥éª¤ 6: éªŒè¯æž„å»ºäº§ç‰©
      # ------------------------------------------
      - name: âœ… Verify build artifacts
        run: |
          echo "ðŸ“‹ Verifying build artifacts..."

          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          required_files=(
            "dist/manifest.json"
            "dist/icons/icon16.png"
            "dist/icons/icon48.png"
            "dist/icons/icon128.png"
          )

          all_ok=true
          for file in "${required_files[@]}"; do
            if test -f "$file"; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file NOT FOUND"
              all_ok=false
            fi
          done

          if [ "$all_ok" = true ]; then
            echo "âœ… Build verification passed"
            exit 0
          else
            echo "âŒ Build verification FAILED"
            exit 1
          fi

      # ------------------------------------------
      # æ­¥éª¤ 7: CI æ€»ç»“
      # ------------------------------------------
      - name: ðŸ“£ CI Summary
        if: success()
        run: |
          echo "## âœ… CI Checks Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All quality checks passed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code linting (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Type checking (TypeScript)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit tests with coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build succeeded and verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Single command execution (no redundant checks)" >> $GITHUB_STEP_SUMMARY
          echo "- Optimized CI pipeline" >> $GITHUB_STEP_SUMMARY
